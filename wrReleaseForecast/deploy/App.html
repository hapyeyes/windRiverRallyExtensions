<!DOCTYPE html>
<html>
<head>
    <title>wrReleaseBurndown</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Rally.example.BurnCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",config:{completedScheduleStateNames:["Accepted"]},constructor:function(config){this.initConfig(config),this.callParent(arguments)},getDerivedFieldsOnInput:function(){var completedScheduleStateNames=this.getCompletedScheduleStateNames(),totalBackLogStateNames=["Backlog","Defined","In Progress","Complete","Accepted"];return[{as:"AcceptedPoints",f:function(snapshot){var ss=snapshot.ScheduleState;return completedScheduleStateNames.indexOf(ss)>-1&&snapshot.PlanEstimate?snapshot.PlanEstimate:0}},{as:"TotalBacklog",f:function(snapshot){var ss=snapshot.ScheduleState;return totalBackLogStateNames.indexOf(ss)>-1&&snapshot.PlanEstimate?snapshot.PlanEstimate:0}}]},getMetrics:function(){return[{field:"AcceptedPoints",as:"Accepted",f:"sum",display:"line"},{field:"TotalBacklog",as:"Total Backlog",f:"sum",display:"line"}]},getSummaryMetricsConfig:function(){return[{as:"Scope_max",f:function(seriesData){var max=0,i=0;for(i=0;seriesData.length>i;i++)seriesData[i].Accepted+seriesData[i]["Total Backlog"]>max&&(max=seriesData[i].Accepted+seriesData[i]["Total Backlog"]);return max}}]},getDerivedFieldsAfterSummary:function(){return[{as:"Accepted Prediction",f:function(row,index,summaryMetrics,seriesData){return null},display:"line",dashStyle:"Dash"},{as:"Total Backlog Prediction",f:function(row,index,summaryMetrics,seriesData){return null},display:"line",dashStyle:"Dash"}]},getProjectionsConfig:function(){var days=(this.scopeEndDate.getTime()-Rally.util.DateTime.fromIsoString(this.startDate).getTime())/864e5,doubleTimeboxEnd=Ext.Date.add(Rally.util.DateTime.fromIsoString(this.startDate),Ext.Date.DAY,2*Math.floor(days)-1),timeboxEnd=Ext.Date.add(this.scopeEndDate,Ext.Date.DAY,-1);return void 0===this.projectionsConfig&&(this.projectionsConfig={doubleTimeboxEnd:doubleTimeboxEnd,timeboxEnd:timeboxEnd,series:[{as:"Accepted Prediction",field:"Accepted"},{as:"Total Backlog Prediction",field:"Total Backlog"}],continueWhile:function(point){var dt=Rally.util.DateTime.fromIsoString(point.tick),end=this.series[0].slope>=0?this.timeboxEnd:this.doubleTimeboxEnd;return end>dt}}),this.projectionsConfig},_firstNonZero:function(data){var i;for(i=0;data.length>i;i++)if(data[i]>0)return i;return 0},_leastSquares:function(todoValues,firstIndex,lastIndex){var n=lastIndex+1-firstIndex,i,sumx=0,sumx2=0,sumy=0,sumy2=0,sumxy=0,slope,yintercept;for(i=firstIndex;lastIndex>=i;i++)sumx+=i,sumx2+=i*i,sumy+=todoValues[i],sumy2+=todoValues[i]*todoValues[i],sumxy+=i*todoValues[i];return slope=(n*sumxy-sumx*sumy)/(n*sumx2-sumx*sumx),yintercept=(sumy*sumx2-sumx*sumxy)/(n*sumx2-sumx*sumx),{slope:slope,yintercept:yintercept}},_indexOfDate:function(chartData,date){var dateStr=Ext.Date.format(date,"Y-m-d");return chartData.categories.indexOf(dateStr)},_removeFutureSeries:function(chartData,seriesIndex,dayIndex){if(chartData.series[seriesIndex].data.length>dayIndex)for(;++dayIndex<chartData.series[seriesIndex].data.length;)chartData.series[seriesIndex].data[dayIndex]=null},_projectionsSlopePositive:function(chartData){return chartData.projections&&chartData.projections.series?chartData.projections.series[0].slope>=0:!0}}),Ext.define("CustomApp",{extend:"Rally.app.App",requires:["Rally.example.BurnCalculator"],componentCls:"app",items:[{xtype:"container",itemId:"pulldown-container",layout:{type:"hbox",align:"stretch"}}],forecastChart:void 0,launch:function(){var me=this;me._loadReleases()},getSettingsFields:function(){return[{name:"setting1",xtype:"rallytextfield"}]},_getAppSettings:function(){},_loadReleases:function(){var me=this,iterComboBox=Ext.create("Rally.ui.combobox.ReleaseComboBox",{itemId:"release-combobox",fieldLabel:"Release",labelAlign:"right",width:300,listeners:{ready:me._createChart,select:me._createChart,scope:me}});me.down("#pulldown-container").add(iterComboBox)},_getFilters:function(releaseValue){var releaseFilter=Ext.create("Rally.data.lookback.QueryFilter",{property:"Release",operation:"=",value:releaseValue}),typeHierarchyFilter=Ext.create("Rally.data.lookback.QueryFilter",{property:"_TypeHierarchy",operation:"=",value:"HierarchicalRequirement"});return releaseFilter},_getStoreConfig:function(myFilters){return console.log("myFilters: ",myFilters),console.log("context: ",this.getContext().getDataContext()),{filters:myFilters,fetch:["ScheduleState","PlanEstimate"],hydrate:["ScheduleState"],context:this.getContext().getDataContext(),autotload:!0,limit:1/0}},_createChart:function(){console.log("creating chart");var me=this,releaseComboBox=this.down("#release-combobox"),release=releaseComboBox.getRecord(),endDateFieldName=releaseComboBox.getEndDateField(),startDateFieldName=releaseComboBox.getStartDateField(),selectedReleaseObjectId=release.get("ObjectID");console.log("Release",release),console.log("Release",release.get("PlannedVelocity"),release.get("PlannedEstimate"));var myFilters=me._getFilters(selectedReleaseObjectId);me.forecastChart&&(console.log("Chart Exists"),me.remove("forecastChart")),console.log("Chart Does Not Exist"),me.forecastChart=Ext.create("Rally.ui.chart.Chart",{itemId:"forecastChart",storeType:"Rally.data.lookback.SnapshotStore",storeConfig:me._getStoreConfig(myFilters),calculatorType:"Rally.example.BurnCalculator",calculatorConfig:{completedScheduleStateNames:["Accepted"],enableProjections:!0,startDate:release.get(startDateFieldName),scopeEndDate:release.get(endDateFieldName)},chartColors:["#005eb8","#8dc63f","#666666","#c0c0c0"],chartConfig:me._getChartConfig()}),me.add(me.forecastChart)},_getChartConfig:function(){return{chart:{defaultSeriesType:"area",zoomType:"xy"},title:{text:"Wind River Forecast"},xAxis:{categories:[],tickmarkPlacement:"on",tickInterval:7,title:{text:"Date",margin:12},maxPadding:.25,labels:{x:0,y:20,overflow:"justify"}},yAxis:[{title:{text:"Points"}}],tooltip:{formatter:function(){return""+this.x+"<br />"+this.series.name+": "+this.y}},plotOptions:{series:{marker:{enabled:!1,states:{hover:{enabled:!0}}},connectNulls:!0},column:{pointPadding:0,borderWidth:0,stacking:null,shadow:!1}}}}});

            Rally.launchApp('CustomApp', {
                name:"wrReleaseBurndown",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
